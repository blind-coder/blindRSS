<html>
<head>
<title>blindRSS</title>
<link rel='stylesheet' href='style.css'>
<script type="text/javascript">
var feedarray = new Array();
/*
 * feedarray
 * array = (ID, name, array = (title, array=(line), link, itemid, isread))
 *
 */
var hierarchy = new Array();
/*
 * hierarchy
 * array = (ID, enum(0=feed, 1=dir), feedarrayindex||name, 0||array=(hierarchy));
 * Yes, I know, this is somewhat brain damaged. If you have a better idea, I'm all ears.
 */
var feedbeingreloaded = 0;
var reloadall = 0;
var request;
var Width = window.innerWidth;
var Height = window.innerHeight;
var rollUpHeightOriginals = new Array();

function resize(){{{
	Width = window.innerWidth;
	Height = window.innerHeight;
	if (document.getElementById("subnavigationscrollouter")){
		document.getElementById("subnavigationscrollouter").style.height=Height-167+"px";
		document.getElementById("contentinner").style.height=Height-302+"px";
	}
}}}
function rollUp(x){{{
	var a = document.getElementById("arollUp"+x);
	var div = document.getElementById("divrollUp"+x);
	var img = document.getElementById("imgrollUp"+x);
	var ul = document.getElementById("subNavigation"+x);
	rollUpHeightOriginals[x] = div.clientHeight;
	div.style.visibility="collapse";
	div.style.height=0;
	a.href="javascript:rollDown('"+x+"');";
	img.src="go-down.png";
}}}
function rollDown(x){{{
	var a = document.getElementById("arollUp"+x);
	var div = document.getElementById("divrollUp"+x);
	var img = document.getElementById("imgrollUp"+x);
	var ul = document.getElementById("subNavigation"+x);
	div.style.visibility="visible";
	div.style.height=rollUpHeightOriginals[x];
	a.href="javascript:rollUp('"+x+"');";
	img.src="go-up.png";
}}}
window.onresize=resize;
function showstatus(stat){{{
// Changes the text of the status line at the top to 'stat'
	var statline=document.getElementById("statusline");

	statline.firstChild.nodeValue="Status: " + stat;
}}}
function ajaxManager() {{{
// returns an XMLHttpRequest Object
	var r;
	if (document.getElementById) {
		if (window.XMLHttpRequest) {
			r=new XMLHttpRequest();
		}
	}
	if (r){
		return r;
	} else {
		alert ("Too cool for IE!");
	}
}}}
function processMarkRead() {{{
// Processes Requests for marking a feed entry as 'read'
	if (request.readyState == 4) {
		if (request.status == 200){
		} else {
			showstatus("Error marking entry as 'read': " + request.status + " " + request.statusText);
		}
	}
}}}
function markReadAll(feedid) {{{
// Processes Requests for marking a whole feed as 'read'
	if (confirm("Mark all entries as 'read'?")){
		request=ajaxManager();

		request.open("GET", "markreadall.php?feedid=" + feedarray[feedid][0], true);
		request.onreadystatechange = processMarkRead;
		showstatus("Marking all entries as 'read'");
		request.send(null);
		for (itemid = 0; itemid < feedarray[feedid][2].length; itemid++){
			feedarray[feedid][2][itemid][4] = 1;
		}
		showItems(feedid);
		document.getElementById("aNewMessages"+feedid).style.visibility="hidden";
	}
}}}
function showDetails(feedid, itemid){{{
// displays the details of a feed entry in the main display area and marks the entry as 'read'
	var contentheadline=document.getElementById("contentheadline");
	var contentcontent=document.getElementById("contentcontent");

	contentheadline.firstChild.nodeValue=feedarray[feedid][2][itemid][0];
	contentheadline.href=feedarray[feedid][2][itemid][2];
	var txt;
	for (var i=0; i<feedarray[feedid][2][itemid][1].length; i++){
		if (txt){
			txt = txt + feedarray[feedid][2][itemid][1][i] + "<br>";
		} else {
			txt = feedarray[feedid][2][itemid][1][i] + "<br>";
		}
	}

	contentcontent.innerHTML=txt;
	request=ajaxManager();

	request.open("GET", "markread.php?itemid="+feedarray[feedid][2][itemid][3], true);
	feedarray[feedid][2][itemid][4] = 1;
	showItems(feedid);
	request.onreadystatechange = processMarkRead;
	showstatus("Marking entry as 'read'");
	request.send(null);
	var newitems = 0;
	for (var i=0; i<feedarray[feedid][2].length; i++){
		if (feedarray[feedid][2][i][4] == 0){ // not read
			newitems++;
		}
	}
	if (newitems == 0){
		document.getElementById("aNewMessages"+feedid).style.visibility="hidden";
	}
}}}
function showItems(id){{{
// shows the items of a feed in the top display area
// new ones are in bold
	var feed;
	feed = feedarray[id];

	var div = document.getElementById("subnavigation");
	div.style.marginLeft = "3px";
	if (div.firstChild){
		while(div.firstChild){
			div.removeChild(div.firstChild);
		}
	}
	for (var i=0; i < feed[2].length; i++){
		var a=document.createElement("a");
		a.href="javascript:showDetails("+id+","+i+");";
		a.appendChild(document.createTextNode(feed[2][i][0]));

		if(feed[2][i][4] == 1){
			div.appendChild(a);
		} else {
			var b = document.createElement("b");
			b.appendChild(a);
			div.appendChild(b);
		}
		div.appendChild(document.createElement("br"));
	}
}}}
function processFeed() {{{
// processes the update of a single feed and hides/unhides the 'new entries' image on demand
	if (request.readyState == 4) {
		if (request.status == 200){
			showstatus("Reloading feed");
			var feed = request.responseXML.firstChild;
			var id = feed.firstChild;
			var item = id.nextSibling;
			var feedarrayptr;
			var feedarrayid;
			var feedarrayitem;
			for (var i=0; i<feedarray.length; i++){
				if (feedarray[i][0] == id.firstChild.nodeValue){
					feedarrayid=i;
					feedarrayptr=feedarray[i];
					feedarrayitem=i;
					i=feedarray.length;
				}
			}
			if (!feedarrayptr){
				showstatus("Couldn't find feed id " + id.firstChild.nodeValue);
				return;
			}
			feedarrayptr[2] = new Array();
			feedarrayptr = feedarrayptr[2];
			while(item){
				var itemid = item.firstChild;
				var title = itemid.nextSibling;
				var content = title.nextSibling;
				var link = content.nextSibling;
				var isread = link.nextSibling;

				var newitem = feedarrayptr.length;

				feedarrayptr[newitem] = new Object();
				feedarrayptr[newitem][0] = title.firstChild.nodeValue;
				feedarrayptr[newitem][1] = new Array();
				var line = content.firstChild;
				var ptr = feedarrayptr[newitem][1];
				while (line && line.firstChild){
					ptr[ptr.length] = line.firstChild.nodeValue;
					line=line.nextSibling;
				}
				if (link.firstChild){
					feedarrayptr[newitem][2] = link.firstChild.nodeValue;
				}
				if (itemid.firstChild){
					feedarrayptr[newitem][3] = itemid.firstChild.nodeValue;
				}
				if (isread.firstChild){
					feedarrayptr[newitem][4] = isread.firstChild.nodeValue;
				}

				if (isread.firstChild.nodeValue == 0){
					var a = document.getElementById("aNewMessages"+feedarrayitem);
					if (a){
						a.style.visibility="visible";
					}
				}
				item=item.nextSibling;
			}
			showstatus("Feed reloaded");
			request = null;
			if (reloadall == 1){
				reloadAllFeeds();
			} else {
				showItems(feedarrayitem);
			}
		} else {
			showstatus("Error fetching Feed: " + request.status + " " + request.statustext);
		}
	}
}}}
function reloadFeed(i){{{
// initiates the update of the entries of a single feed
	showstatus("Loading contents of '" + feedarray[i][1] + "'");
	request=ajaxManager();
	if (document.getElementById("onlyunread").checked){
		request.open("GET", "feed.php?id="+feedarray[i][0]+"&onlychecked=1", true);
	} else {
		request.open("GET", "feed.php?id="+feedarray[i][0], true);
	}
	request.onreadystatechange=processFeed;
	request.send(null);
}}}
function reloadAllFeeds(){{{
// initiates the update of the entries of all feeds
	reloadall = 1;
	if(feedarray[feedbeingreloaded]){
		request=ajaxManager();
		showstatus("Reloading Feed '" + feedarray[feedbeingreloaded][1] + "'");
		if (document.getElementById("onlyunread").checked){
			request.open("GET", "feed.php?id="+feedarray[feedbeingreloaded][0]+"&onlychecked=1", true);
		} else {
			request.open("GET", "feed.php?id="+feedarray[feedbeingreloaded][0], true);
		}
		request.onreadystatechange=processFeed;
		request.send(null);
		feedbeingreloaded++;
	} else {
		feedbeingreloaded = 0;
		reloadall = 0;
		showstatus("All feeds (re)loaded");
		return;
	}
}}}
function showNavigation(hierarchyLevel, parentNavigation) {{{
	var i;
	for (i=0; i<hierarchyLevel.length; i++){
		/* array = (ID, enum(0=feed, 1=dir), feedarrayindex||name, 0||array=(hierarchy)); */
		if (hierarchyLevel[i][1] == 1){
			var table=document.createElement("table");
			var tbody=document.createElement("tbody");
			var tr=document.createElement("tr");
			var td=document.createElement("td");
			var div=document.createElement("div");

			td.setAttribute("class", "navigationheadline");

			div.appendChild(document.createTextNode(hierarchyLevel[i][2]));
			div.style.position="relative";
			div.style.top="0px";
			div.style.left="0px";

			divdiv=document.createElement("div");

			a=document.createElement("a");
			var img=document.createElement("img");
			a.href="javascript:rollUp('"+i+"');";
			a.id="arollUp"+i;
			divdiv.style.position="absolute";
			divdiv.style.right="0px";
			divdiv.style.top="0px";
			img.title="Close";
			img.src="go-up.png";
			img.border=0;
			img.border=0;
			img.id="imgrollUp"+i;
			a.appendChild(img);
			divdiv.appendChild(a);
			div.appendChild(divdiv);

			td.appendChild(div);
			tr.appendChild(td);
			tbody.appendChild(tr);
			table.appendChild(tbody);
			parentNavigation.appendChild(table);

			div=document.createElement("div");
			div.id="divrollUp"+i;
			div.style.position="relative";
			div.style.top="0px";
			div.style.left="0px";
			var ul=document.createElement("ul");
			ul.style.paddingLeft="10px";
			ul.style.marginTop="0px";
			ul.style.marginBottom="0px";
			ul.id="subNavigation"+i;

			div.appendChild(ul);
			parentNavigation.appendChild(div);
			showNavigation(hierarchyLevel[i][3], ul);
			continue;
		}

		/* array = (ID, name, array = (title, array=(line), link, itemid, isread)) */
		var feedarrayindex = hierarchyLevel[i][2];
		var name = feedarray[feedarrayindex][1];
		var id = feedarray[feedarrayindex][0];

		var table=document.createElement("table");
		var tbody=document.createElement("tbody");
		var tr=document.createElement("tr");
		var td=document.createElement("td");
		var div=document.createElement("div");
		var divdiv=document.createElement("div");

		td.setAttribute("class", "navigationheadline");
		var a = document.createElement("a");
		a.href="javascript:showItems("+feedarrayindex+");";
		a.appendChild(document.createTextNode(name));
		div.appendChild(a);
		div.style.position="relative";
		div.style.top="0px";
		div.style.left="0px";

		divdiv=document.createElement("div");

		a=document.createElement("a");
		var img=document.createElement("img");
		a.href="javascript:reloadFeed("+feedarrayindex+");";
		divdiv.style.position="absolute";
		divdiv.style.right="32px";
		divdiv.style.top="0px";
		img.title="Reload this feed";
		img.src="view-refresh.png";
		img.border=0;
		img.border=0;
		a.appendChild(img);
		divdiv.appendChild(a);
		div.appendChild(divdiv);

		divdiv=document.createElement("div");

		a=document.createElement("a");
		a.href="javascript:markReadAll("+feedarrayindex+");";
		var img=document.createElement("img");
		divdiv.style.position="absolute";
		divdiv.style.right="48px";
		divdiv.style.top="0px";
		img.title="New messages!";
		img.src="mail-message-new.png";
		img.border=0;
		img.border=0;
		a.appendChild(img);
		a.id="aNewMessages"+feedarrayindex;
		a.style.visibility="hidden";
		divdiv.appendChild(a);
		div.appendChild(divdiv);

		a=document.createElement("a");
		a.href="javascript:removeFeed("+feedarrayindex+");";
		divdiv=document.createElement("div");
		divdiv.style.position="absolute";
		divdiv.style.right="0px";
		divdiv.style.top="0px";
		img=document.createElement("img");
		img.title="Delete this feed";
		img.src="process-stop.png";
		img.border=0;
		img.border=0;
		a.appendChild(img);
		divdiv.appendChild(a);
		div.appendChild(divdiv);
		td.appendChild(div);
		tr.appendChild(td);

		tbody.appendChild(tr);
		table.appendChild(tbody);
		table.setAttribute("id", "feed"+id);
		parentNavigation.appendChild(table);
	}
}}}
function recursiveHierarchySearchForParentID(hierarchyLevel, parentID){{{
	var i;
	for (i=0; i < hierarchyLevel.length; i++){
		if (hierarchyLevel[i][0] == parentID){
			/* array = (ID, enum(0=feed, 1=dir), feedarrayindex||name, 0||array=(hierarchy)); */
			return hierarchyLevel[i];
		}
		if (hierarchyLevel[i][1] == 1){
			var retVal = recursiveHierarchySearchForParentID(hierarchyLevel[i][3], parentID);
			if (retVal != -1){
				return retVal;
			}
		}
	}
	return -1;
}}}
function getHierarchyPtrToParentID(parentID) {{{
	return recursiveHierarchySearchForParentID(hierarchy, parentID);
}}}
function recursivePathToParentID(hierarchyLevel, parentID){{{
	var i;
	for (i=0; i < hierarchyLevel.length; i++){
		if (hierarchyLevel[i][0] == parentID){
			/* array = (ID, enum(0=feed, 1=dir), feedarrayindex||name, 0||array=(hierarchy)); */
			return "/"+hierarchyLevel[i][2];
		}
		if (hierarchyLevel[i][1] == 1){
			var retVal = recursivePathToParentID(hierarchyLevel[i][3], parentID);
			if (retVal != -1){
				return "/"+hierarchyLevel[i][2]+retVal;
			}
		}
	}
	return -1;
}}}
function getPathToParentID(parentID) {{{
	return recursivePathToParentID(hierarchy, parentID);
}}}
function processFeedList() {{{
// processes the request for updating the feed list
	if (request.readyState == 4) {
		if (request.status == 200){
			var navigation=document.getElementById("navigation");
			var feeds;
			var feed;
			feeds=request.responseXML.firstChild;
			feed=feeds.firstChild;
			while(feed){
				/* childNode[0]: id
				   childNode[1]: name 
				   childNode[2]: isdir
				   childNode[3]: parentID */
				var feedarraynewelement = feedarray.length;
				var hierarchynewelement = hierarchy.length;
				var id;
				var name;
				var isdir;
				var parentID;
				id=feed.childNodes[0].firstChild.nodeValue;
				name=feed.childNodes[1].firstChild.nodeValue;
				isdir=feed.childNodes[2].firstChild.nodeValue;
				parentID=feed.childNodes[3].firstChild.nodeValue;

				var hierarchyptr;
				var i;
				if (parentID == 0){
					hierarchy[hierarchynewelement] = new Object();
					hierarchyptr = hierarchy[hierarchynewelement];
				} else {
					hierarchyptr = getHierarchyPtrToParentID(parentID);
					hierarchyptr = hierarchyptr[3];
					var hptrnewelement = hierarchyptr.length;
					hierarchyptr[hptrnewelement] = new Object();
					hierarchyptr = hierarchyptr[hptrnewelement];
				}
				if (isdir == 0){
					feedarray[feedarraynewelement] = new Object();
					feedarray[feedarraynewelement][0] = id;
					feedarray[feedarraynewelement][1] = name;

					hierarchyptr[0] = id;
					hierarchyptr[1] = 0;
					hierarchyptr[2] = feedarraynewelement;
					hierarchyptr[3] = 0;
				} else {
					hierarchyptr[0] = id;
					hierarchyptr[1] = 1;
					hierarchyptr[2] = name;
					hierarchyptr[3] = new Array();
					var option=document.createElement("option");
					option.text=getPathToParentID(id);
					option.value=id;
					document.getElementById("addDir").appendChild(option);
				}
				feed=feed.nextSibling;
			}
			showstatus(feedarray.length + " Feeds loaded");
			var navigation=document.getElementById("navigation");
			showNavigation(hierarchy, navigation);
			reloadAllFeeds();
		} else {
			showstatus("Error fetching FeedList: " + request.status + " " + request.statustext);
		}
	}
}}}
function loadFeeds() {{{
// loads all feeds at startup or upon request
	var navigation=document.getElementById("navigation");

	while (navigation.lastChild){
		navigation.removeChild(navigation.lastChild);
	}
	feedarray = new Array();
	hierarchy = new Array();
	showstatus("Loading Feeds");
	request=ajaxManager();

	request.open("GET", "feeds.php", true);
	request.onreadystatechange = processFeedList;
	request.send(null);
}}}
function processAddDelFeed() {{{
// processes addition and deletion of feeds. really just outputs the text from the request
// and calls loadFeeds
	if (request.readyState == 4) {
		if (request.status == 200){
			status=request.responseXML.firstChild;
			alert(status.firstChild.nodeValue);
			loadFeeds();
		}
	}
}}}
function addFeed(){{{
// requests addition of a feed from the server
	request=ajaxManager();

	request.open("GET", "add.php?url="+document.getElementById("addUrl").value+"&name="+document.getElementById("addName").value+"&parentID="+document.getElementById("addDir").value);
	request.onreadystatechange = processAddDelFeed;
	request.send(null);
}}}
function removeFeed(i){{{
// requests deletion of a feed from the server
	if (confirm("Really delete Feed?")){
		request=ajaxManager();

		request.open("GET", "del.php?id="+feedarray[i][0]);
		request.onreadystatechange = processAddDelFeed;
		request.send(null);
	}
}}}
</script>
</head>
<body onLoad="javascript:resize();loadFeeds();">
<table class='main'>
	<tr class='headline'>
		<td colspan='2'>
			<table width='100%'>
				<tr>
					<td width='50%' class='headline' align='left'>blindRSS</td>
					<td width='50%' valign='top' align='right'>
						<nobr><form><input type='text' id='addUrl' value='http://foo/bar.rss'> <input type='text' id='addName' value='Foobar RSS'><select id='addDir'><option value='0'>/</option></select><input type='button' value='add feed' onclick="javascript:addFeed();"></form></nobr><br>
						<a href='javascript:reloadAllFeeds();'><img src='view-refresh.png' border='0'></a><br>
						Show only unread <input type='checkbox' id='onlyunread' name='onlyunread' checked>
					</td>
				</tr>
			</table>
		</td>
	</tr>
	<tr class='subheadline'>
		<td class='subheadline' colspan='2'>blindcoders simple RSS Reader</td>
	</tr>
	<tr class='statusline'>
		<td id='statusline' class='statusline' colspan='2'>Status: </td>
	</tr>
	<tr class='main'>
		<td class='left' valign='top'>
			<div id='subnavigationscrollouter' dir="rtl" style="height: 400px; width:100%; overflow: auto;">
				<div width="100%" dir="ltr">
					<table class='navigation'>
						<tr class='navigation'>
							<td id='navigation' class='navigation'>
							</td>
						</tr>
					</table>
				</div>
			</div>
		</td>
		<td class='right' valign='top'>
			<table class='content'>
				<tr class='content'>
					<td class='content'>
						<div id='subnavigationscrollinner' dir="rtl" style="height:80px; width:100%; overflow: auto;">
							<div width="100%" dir="ltr" id='subnavigation'>
							</div>
						</div>
					</td>
				</tr>
				<tr>
					<td>
						<hr>
					</td>
				</tr>
				<tr class='content'>
					<td class='content'>
						<table>
							<tr>
								<td class='contentheadline'>
									<b><a href='#' id="contentheadline">Welcome to blindRSS</a></b>
								</td>
							</tr>
							<tr>
								<td>
									<div id="contentinner" dir='rtl' style="height:265px; width:100%; overflow: auto;">
										<div width="100%" dir="ltr">
											<table>
												<td id="contentcontent" class='contentcontent'>
													blindRSS is a very simple browser-operated RSS reader.<br>
													You can click through the feeds on the left, use the (hopefully self-explanatory) icons next to them to manipulate them and do all the other stuff a RSS reader should do.<br>
													It's programmed so that the feeds are re-read by a cronjob or daemon and as much functionality as possible is done within the client. Thus the server only does what it is IMO supposed to do: serve data.<br>
													<br>
													Enjoy :-)
												</td>
											</table>
										</div>
									</div>
								</td>
							</tr>
						</table>
					</td>
				</tr>
			</table>
		</td>
	</tr>
</table>
</body>
</html>
